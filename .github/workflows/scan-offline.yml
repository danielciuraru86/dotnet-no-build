name: Scan Offline

on:
  push:
    branches:
      - trivy-offline   # Trigger for the feature branch

jobs:
  Scan:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Setup .NET SDK
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0'

      # Step 3: Restore .NET dependencies and update lock file
      - name: Restore and update lock file
        run: dotnet restore ./src/MySampleDotNetApp/MySampleDotNetApp.csproj --use-lock-file --force-evaluate

      # Step 4: Download Trivy databases using the Aqua Scanner image
      - name: Download Trivy databases
        id: download-db
        uses: docker://aquasec/aqua-scanner
        with:
          args: trivy fs --download-db-only

      # Step 5: Run Trivy scan in offline mode
      - name: Run Trivy scan (Offline)
        uses: docker://aquasec/aqua-scanner
        with:
          args: |
            trivy fs --offline-scan --skip-db-update --skip-java-db-update --skip-check-update --sast --reachability --scanners misconfig,vuln,secret /github/workspace
        env:
          AQUA_KEY: ${{ secrets.AQUA_KEY }}
          AQUA_SECRET: ${{ secrets.AQUA_SECRET }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AQUA_URL: ${{ vars.AQUA_URL }}
          CSPM_URL: ${{ vars.CSPM_URL }}
          TRIVY_RUN_AS_PLUGIN: "aqua"
          # Mount the downloaded database path
          TRIVY_CACHE_DIR: /tmp/.cache/trivy  # Default cache directory for Trivy
